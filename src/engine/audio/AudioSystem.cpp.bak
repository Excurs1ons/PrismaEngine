#include "AudioSystem.h"
#include "../Helper.h"
#include "Logger.h"

// 条件包含音频后端头文件
#ifdef PRISMA_ENABLE_AUDIO_SDL3
#include <SDL3/SDL_init.h>
#include "AudioBackendSDL3.h"
#endif

#ifdef PRISMA_ENABLE_AUDIO_XAUDIO2
#include "AudioBackendXAudio2.h"
#endif

#include <fstream>
#include <iostream>
#include <vector>
namespace PrismaEngine {
    namespace Audio {

        AudioSystem::AudioSystem()
        {
            
        }

        AudioSystem::~AudioSystem()
        {
            Shutdown();
        }
        bool AudioSystem::Initialize(AudioBackendType audioBackendType, AudioFormat audioFormat)
        {
            switch (audioBackendType) {
#ifdef PRISMA_ENABLE_AUDIO_SDL3
                case AudioBackendType::SDL3:
                    audioBackend = std::make_unique<AudioBackendSDL3>();
                    break;
#endif

#ifdef PRISMA_ENABLE_AUDIO_XAUDIO2
                case AudioBackendType::XAudio2:
                    audioBackend = std::make_unique<AudioBackendXAudio2>();
                    break;
#endif

                case AudioBackendType::None:
                default:
                    LOG_ERROR("AudioSystem",
                              "未指定有效的音频后端类型: AudioBackend@{0}",
                              static_cast<int>(audioBackendType));
                    break;
            }
            if (audioBackend)
                return audioBackend->Initialize(audioFormat);
            else
                LOG_ERROR("AudioSystem", "指定的音频后端创建失败: AudioBackend@{0}", static_cast<int>(audioBackendType));
            return false;
        }
        // 音频回调函数
#ifdef PRISMA_ENABLE_AUDIO_SDL3
        void audioCallback(void* userdata, Uint8* stream, int len) {
            // 这里填充音频数据
            // 例如播放静音
            SDL_memset(stream, 0, len);
        }
#endif
        bool AudioSystem::Initialize()
        {
            AudioFormat audioFormat;
            return Initialize(AudioBackendType::XAudio2, audioFormat);
        }

        void AudioSystem::Shutdown()
        {
            if (audioBackend)
                audioBackend->Shutdown();
        }

        bool AudioSystem::PlayAudioFile(const char* filename)
        {
            if (!audioBackend) {
                LOG_ERROR("Audio", "音频系统未初始化");
                return false;
            }

            std::cout << "Successfully played audio file: " << filename << std::endl;
            return true;
        }
    }
}
