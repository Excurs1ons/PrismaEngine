name: Build Prisma Engine

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        build_type: [release, debug]
        
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Print Build Environment Info
      shell: powershell
      run: |
        Write-Host "Build Environment Info:"
        Write-Host "OS: ${{ runner.os }}"
        Write-Host "Build Type: ${{ matrix.build_type }}"
        Write-Host "Work Dir: $(Get-Location)"
        try {
          $cmakeVersion = cmake --version | Select-Object -First 1
          Write-Host "CMake Version: $cmakeVersion"
        } catch {
          Write-Host "CMake Version: Unavailable"
        }
        try {
          $gitVersion = git --version
          Write-Host "Git Version: $gitVersion"
        } catch {
          Write-Host "Git Version: Unavailable"
        }
        try {
          $pythonVersion = python --version 2>$null
          if (-not $pythonVersion) { $pythonVersion = & python -V 2>$null }
          if ($pythonVersion) {
            Write-Host "Python Version: $pythonVersion"
          } else {
            Write-Host "Python Version: Python not found"
          }
        } catch {
          Write-Host "Python Version: Python not found"
        }
        try {
          # 简化内存查询逻辑，防止单行复杂命令解析出错
          $os = Get-CimInstance -ClassName Win32_OperatingSystem
          $total = [math]::Round($os.TotalVisibleMemorySize/1MB, 2)
          $free = [math]::Round($os.FreePhysicalMemory/1MB, 2)
          Write-Host "Memory (MB): Total=$total, Free=$free"
        } catch {
          Write-Host "Memory info unavailable"
        }
    
    - name: Cache vcpkg dependencies
      uses: actions/cache@v4
      id: cache-vcpkg
      with:
        path: |
          ./vcpkg_installed
          ./build/vcpkg_installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-
    
    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          ./build/${{ matrix.build_type }}
        key: ${{ runner.os }}-build-${{ matrix.build_type }}-${{ hashFiles('src/**', 'CMakeLists.txt', 'vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ matrix.build_type }}-
          ${{ runner.os }}-build-
    
    - name: Fetch all history for vcpkg
      run: |
        git fetch --all
      
    - name: Setup vcpkg
      run: |
        ./vcpkg/bootstrap-vcpkg.bat
      
    - name: Configure CMake
      run: |
        cmake --preset vs2022-${{ matrix.build_type }}
      
    - name: Build
      run: |
        echo "开始构建 ${{ matrix.build_type }} 配置..."
        # 使用最大并行度构建，但限制在合理范围内以避免资源耗尽
        cmake --build build/${{ matrix.build_type }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --parallel 4 || {
          echo "构建失败，尝试获取详细错误信息..."
          cmake --build build/${{ matrix.build_type }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --verbose 2>&1 | tail -n 100
          exit 1
        }
      
    - name: Install
      run: |
        echo "开始安装 ${{ matrix.build_type }} 配置..."
        cmake --install build/${{ matrix.build_type }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --prefix build/${{ matrix.build_type }}/install || {
          echo "安装失败，尝试获取详细错误信息..."
          cmake --install build/${{ matrix.build_type }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --prefix build/${{ matrix.build_type }}/install --verbose 2>&1 | tail -n 100
          exit 1
        }
      
    - name: Create Distribution Package
      run: |
        echo "创建分发包..."
        cmake --build build/${{ matrix.build_type }} --target dist --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} || {
          echo "创建分发包失败，尝试获取详细错误信息..."
          cmake --build build/${{ matrix.build_type }} --target dist --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --verbose 2>&1 | tail -n 100
          exit 1
        }
        cmake --build build/${{ matrix.build_type }} --target dist-win --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} || {
          echo "创建Windows分发包失败，尝试获取详细错误信息..."
          cmake --build build/${{ matrix.build_type }} --target dist-win --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --verbose 2>&1 | tail -n 100
          exit 1
        }
      
    - name: Verify Build Artifacts
      shell: powershell
      run: |
        Write-Host "Verifying Build Artifacts..."
        Get-ChildItem -Path "build/${{ matrix.build_type }}" -Force
        
        # Check distribution package
        $tarFile = Get-ChildItem -Path "build/${{ matrix.build_type }}" -Filter "PrismaEngine-*.tar.gz" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($tarFile) {
          Write-Host "Found tar.gz package: $($tarFile.Name)"
          try {
            tar -tzf $tarFile.FullName | Select-Object -First 10
          } catch {
            Write-Host "Cannot list tar.gz content, but file exists."
          }
        } else {
          Write-Host "Warning: tar.gz package not found."
        }
        
        $zipFile = Get-ChildItem -Path "build/${{ matrix.build_type }}" -Filter "PrismaEngine-*.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($zipFile) {
          Write-Host "Found zip package: $($zipFile.Name)"
          try {
            Add-Type -AssemblyName System.IO.Compression.FileSystem
            [IO.Compression.ZipFile]::OpenRead($zipFile.FullName).Entries | Select-Object -First 10 | ForEach-Object { $_.FullName }
          } catch {
            Write-Host "Cannot list zip content, but file exists."
          }
        } else {
          Write-Host "Warning: zip package not found."
        }
        
        # Check install directory
        $installDir = "build/${{ matrix.build_type }}/install"
        if (Test-Path $installDir -PathType Container) {
          Write-Host "Install directory content:"
          Get-ChildItem -Path $installDir -Force
        } else {
          Write-Host "Warning: Install directory not found."
        }
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prisma-engine-${{ matrix.build_type == 'release' && 'Release' || 'Debug' }}-windows
        path: |
          build/${{ matrix.build_type }}/PrismaEngine-*.tar.gz
          build/${{ matrix.build_type }}/PrismaEngine-*.zip
          build/${{ matrix.build_type }}/install/**
        if-no-files-found: warn
