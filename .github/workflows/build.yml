name: Build Prisma Engine

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        build_type: [release, debug]
        
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Print Build Environment Info
      run: |
        echo "构建环境信息:"
        echo "操作系统: ${{ runner.os }}"
        echo "构建类型: ${{ matrix.build_type }}"
        echo "工作目录: $(pwd)"
        echo "CMake版本: $(cmake --version | head -n 1)"
        echo "Git版本: $(git --version)"
        echo "Python版本: $(python --version 2>&1 || echo 'Python not found')"
        echo "可用内存: $(Get-CimInstance -ClassName Win32_OperatingSystem | Select-Object @{Name='TotalMemory'; Expression={[math]::Round($_.TotalVisibleMemorySize/1MB, 2)}}, @{Name='FreeMemory'; Expression={[math]::Round($_.FreePhysicalMemory/1MB, 2)}} | ConvertTo-Json || echo 'Memory info not available')"
    
    - name: Cache vcpkg dependencies
      uses: actions/cache@v4
      id: cache-vcpkg
      with:
        path: |
          ./vcpkg_installed
          ./build/vcpkg_installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-
    
    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          ./build/${{ matrix.build_type }}
        key: ${{ runner.os }}-build-${{ matrix.build_type }}-${{ hashFiles('src/**', 'CMakeLists.txt', 'vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ matrix.build_type }}-
          ${{ runner.os }}-build-
    
    - name: Fetch all history for vcpkg
      run: |
        git fetch --all
      
    - name: Setup vcpkg
      run: |
        ./vcpkg/bootstrap-vcpkg.bat
      
    - name: Configure CMake
      run: |
        cmake --preset vs2022-${{ matrix.build_type }}
      
    - name: Build
      run: |
        echo "开始构建 ${{ matrix.build_type }} 配置..."
        # 使用最大并行度构建，但限制在合理范围内以避免资源耗尽
        cmake --build build/${{ matrix.build_type }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --parallel 4 || {
          echo "构建失败，尝试获取详细错误信息..."
          cmake --build build/${{ matrix.build_type }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --verbose 2>&1 | tail -n 100
          exit 1
        }
      
    - name: Install
      run: |
        echo "开始安装 ${{ matrix.build_type }} 配置..."
        cmake --install build/${{ matrix.build_type }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --prefix build/${{ matrix.build_type }}/install || {
          echo "安装失败，尝试获取详细错误信息..."
          cmake --install build/${{ matrix.build_type }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --prefix build/${{ matrix.build_type }}/install --verbose 2>&1 | tail -n 100
          exit 1
        }
      
    - name: Create Distribution Package
      run: |
        echo "创建分发包..."
        cmake --build build/${{ matrix.build_type }} --target dist --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} || {
          echo "创建分发包失败，尝试获取详细错误信息..."
          cmake --build build/${{ matrix.build_type }} --target dist --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --verbose 2>&1 | tail -n 100
          exit 1
        }
        cmake --build build/${{ matrix.build_type }} --target dist-win --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} || {
          echo "创建Windows分发包失败，尝试获取详细错误信息..."
          cmake --build build/${{ matrix.build_type }} --target dist-win --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --verbose 2>&1 | tail -n 100
          exit 1
        }
      
    - name: Verify Build Artifacts
      shell: powershell
      run: |
        Write-Host "验证构建产物..."
        Get-ChildItem -Path "build/${{ matrix.build_type }}" -Force
        
        # 检查分发包文件
        $tarFile = Get-ChildItem -Path "build/${{ matrix.build_type }}" -Filter "PrismaEngine-*.tar.gz" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($tarFile) {
          Write-Host "找到tar.gz分发包: $($tarFile.Name)"
          # 在Windows上使用tar命令（Windows 10+内置）
          try {
            tar -tzf $tarFile.FullName | Select-Object -First 10
          } catch {
            Write-Host "无法列出tar.gz内容，但文件存在"
          }
        } else {
          Write-Host "警告: 未找到tar.gz分发包"
        }
        
        $zipFile = Get-ChildItem -Path "build/${{ matrix.build_type }}" -Filter "PrismaEngine-*.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($zipFile) {
          Write-Host "找到zip分发包: $($zipFile.Name)"
          # 使用Expand-Archive列出zip内容
          try {
            Add-Type -AssemblyName System.IO.Compression.FileSystem
            [IO.Compression.ZipFile]::OpenRead($zipFile.FullName).Entries | Select-Object -First 10 | ForEach-Object { $_.FullName }
          } catch {
            Write-Host "无法列出zip内容，但文件存在"
          }
        } else {
          Write-Host "警告: 未找到zip分发包"
        }
        
        # 检查安装目录
        $installDir = "build/${{ matrix.build_type }}/install"
        if (Test-Path $installDir -PathType Container) {
          Write-Host "安装目录内容:"
          Get-ChildItem -Path $installDir -Force
        } else {
          Write-Host "警告: 未找到安装目录"
        }
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prisma-engine-${{ matrix.build_type == 'release' && 'Release' || 'Debug' }}-windows
        path: |
          build/${{ matrix.build_type }}/PrismaEngine-*.tar.gz
          build/${{ matrix.build_type }}/PrismaEngine-*.zip
          build/${{ matrix.build_type }}/install/**
        if-no-files-found: warn
