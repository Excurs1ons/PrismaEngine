name: Build Prisma Engine

on:
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'assets/**'
      - 'resources/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'assets/**'
      - 'resources/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'

env:
  CMAKE_VERSION: '3.31.0'

jobs:
  build-windows:
    runs-on: windows-latest

    strategy:
      matrix:
        preset: [windows-x64-debug, windows-x64-release]
        include:
          - preset: windows-x64-debug
            build_type: debug
          - preset: windows-x64-release
            build_type: release

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Print Build Environment Info
      shell: powershell
      run: |
        Write-Host "Build Environment Info:"
        Write-Host "OS: ${{ runner.os }}"
        Write-Host "Build Preset: ${{ matrix.preset }}"
        Write-Host "Build Type: ${{ matrix.build_type }}"
        Write-Host "Work Dir: $(Get-Location)"

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          ./build/${{ matrix.preset }}
        key: ${{ runner.os }}-build-${{ matrix.preset }}-${{ hashFiles('src/**', 'CMakeLists.txt', 'CMakePresets.json') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ matrix.preset }}-
          ${{ runner.os }}-build-

    - name: Clean CMake cache
      shell: powershell
      run: |
        # 删除 CMake 缓存文件以确保干净的配置
        if (Test-Path "build/${{ matrix.preset }}/CMakeCache.txt") {
            Remove-Item "build/${{ matrix.preset }}/CMakeCache.txt" -Force
            Write-Host "Removed CMakeCache.txt"
        }

    - name: Configure CMake
      run: cmake --preset ${{ matrix.preset }}

    - name: Build
      run: |
        echo "开始构建 ${{ matrix.build_type }} 配置..."
        cmake --build build/${{ matrix.preset }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --parallel 4

    - name: Install
      run: |
        echo "开始安装 ${{ matrix.build_type }} 配置..."
        cmake --install build/${{ matrix.preset }} --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }} --prefix build/${{ matrix.preset }}/install

    - name: Create Distribution Package
      run: |
        echo "创建分发包..."
        cmake --build build/${{ matrix.preset }} --target dist --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }}
        cmake --build build/${{ matrix.preset }} --target dist-win --config ${{ matrix.build_type == 'release' && 'Release' || 'Debug' }}

    - name: Verify Build Artifacts
      shell: powershell
      run: |
        Write-Host "Verifying Build Artifacts..."
        Get-ChildItem -Path "build/${{ matrix.preset }}" -Force
        exit 0

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prisma-engine-${{ matrix.build_type == 'release' && 'Release' || 'Debug' }}-windows
        path: |
          build/${{ matrix.preset }}/PrismaEngine-*.tar.gz
          build/${{ matrix.preset }}/PrismaEngine-*.zip
          build/${{ matrix.preset }}/install/**
        if-no-files-found: warn
