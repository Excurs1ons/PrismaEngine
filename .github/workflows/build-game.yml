name: Build Game

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/game/**'
      - 'src/runtime/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/game/**'
      - 'src/runtime/**'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - windows
        - android
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
        - Release
        - Debug
      upload_artifact:
        description: 'Upload build artifacts'
        required: true
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  ANDROID_NDK_VERSION: 27.0.12077973

jobs:
  build-windows:
    runs-on: windows-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows' || github.event.inputs.platform == ''
    strategy:
      matrix:
        build_type: [Release, Debug]
        platform: [x64]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/vcpkg_installed
          C:/vcpkg
        key: vcpkg-game-${{ matrix.platform }}-${{ matrix.build_type }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-game-${{ matrix.platform }}-${{ matrix.build_type }}-
          vcpkg-game-${{ matrix.platform }}-

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: '3.31.0'

    - name: Setup vcpkg
      if: steps.cache-vcpkg.outputs.cache-hit != 'true'
      run: |
        ./vcpkg/bootstrap-vcpkg.bat
        ./vcpkg/vcpkg integrate install

    - name: Configure CMake
      run: |
        cmake -B build-${{ matrix.platform }}-${{ matrix.build_type }} `
          -G "Visual Studio 17 2022" `
          -A ${{ matrix.platform }} `
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
          -DCMAKE_TOOLCHAIN_FILE=./vcpkg/scripts/buildsystems/vcpkg.cmake `
          -DVCPKG_TARGET_TRIPLET=${{ matrix.platform }}-windows

    - name: Build Runtime
      run: |
        cmake --build build-${{ matrix.platform }}-${{ matrix.build_type }} `
          --config ${{ matrix.build_type }} `
          --target Runtime `
          --parallel

    - name: Build Game
      run: |
        cmake --build build-${{ matrix.platform }}-${{ matrix.build_type }} `
          --config ${{ matrix.build_type }} `
          --target Game `
          --parallel

    - name: Test
      run: |
        cd build-${{ matrix.platform }}-${{ matrix.build_type }}
        ctest -C ${{ matrix.build_type }} --output-on-failure --parallel

    - name: Package
      if: github.event.inputs.upload_artifact == 'true' || github.event.inputs.upload_artifact == ''
      run: |
        mkdir -p package-${{ matrix.platform }}-${{ matrix.build_type }}

        # Copy executables and DLLs
        copy build-${{ matrix.platform }}-${{ matrix.build_type }}/bin/${{ matrix.build_type }}/Runtime.exe package-${{ matrix.platform }}-${{ matrix.build_type }}/
        copy build-${{ matrix.platform }}-${{ matrix.build_type }}/bin/${{ matrix.build_type }}/*.dll package-${{ matrix.platform }}-${{ matrix.build_type }}/ 2>nul || echo "No additional DLLs"

        # Copy game data
        xcopy assets package-${{ matrix.platform }}-${{ matrix.build_type }}/assets /E /I /Y 2>nul || echo "No assets to copy"
        xcopy projects package-${{ matrix.platform }}-${{ matrix.build_type }}/projects /E /I /Y 2>nul || echo "No projects to copy"

        # Create launcher script
        echo @echo off > package-${{ matrix.platform }}-${{ matrix.build_type }}/RunGame.bat
        echo cd /d "%%~dp0" >> package-${{ matrix.platform }}-${{ matrix.build_type }}/RunGame.bat
        echo start Runtime.exe >> package-${{ matrix.platform }}-${{ matrix.build_type }}/RunGame.bat

        # Create archive
        cd package-${{ matrix.platform }}-${{ matrix.build_type }}
        7z a ../PrismaGame-${{ matrix.platform }}-${{ matrix.build_type }}.zip *

    - name: Upload artifacts
      if: github.event.inputs.upload_artifact == 'true' || github.event.inputs.upload_artifact == ''
      uses: actions/upload-artifact@v4
      with:
        name: PrismaGame-${{ matrix.platform }}-${{ matrix.build_type }}
        path: PrismaGame-${{ matrix.platform }}-${{ matrix.build_type }}.zip
        retention-days: 30

  build-android:
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android' || github.event.inputs.platform == ''
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a]
        build_type: [Release]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Android command line tools
      uses: android-actions/setup-android@v3

    - name: Setup NDK
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q https://dl.google.com/android/repository/android-ndk-r27-linux.zip
        unzip -q android-ndk-r27-linux.zip
        echo "ANDROID_NDK_HOME=$PWD/android-ndk-r27" >> $GITHUB_ENV

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: '3.31.0'

    - name: Setup Ninja
      run: |
        sudo apt-get install -y ninja-build

    - name: Cache vcpkg Android
      uses: actions/cache@v4
      with:
        path: |
          ./vcpkg_installed
        key: vcpkg-game-android-${{ matrix.abi }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-game-android-${{ matrix.abi }}-

    - name: Setup vcpkg
      if: steps.cache-vcpkg-android.outputs.cache-hit != 'true'
      run: |
        ./vcpkg/bootstrap-vcpkg.sh
        ./vcpkg/vcpkg install sdl3 nlohmann-json --triplet ${{ matrix.abi }}-android

    - name: Create Android game project
      run: |
        mkdir -p android-game/app/src/main/{cpp,jniLibs/${matrix.abi},assets}

        # Create CMakeLists.txt for Android game
        cat > android-game/app/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.31)
        project("prismagame")

        add_library(game SHARED
            android_main.cpp
        )

        target_include_directories(game PRIVATE
            ../../src/engine
            ../../src/runtime
            ../../src/game
        )

        target_link_libraries(game
            android
            log
            EGL
            GLESv3
        )
        EOF

        # Create Android manifest
        cat > android-game/app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.prisma.game"
            android:versionCode="1"
            android:versionName="1.0">

            <uses-permission android:name="android.permission.INTERNET" />
            <uses-feature android:glEsVersion="0x00030000" android:required="true" />

            <application
                android:allowBackup="true"
                android:fullBackupContent="false"
                android:icon="@mipmap/ic_launcher"
                android:label="Prisma Game"
                android:theme="@android:style/Theme.NoTitleBar.Fullscreen">

                <activity
                    android:name=".MainActivity"
                    android:exported="true"
                    android:configChanges="orientation|keyboardHidden|screenSize">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>

            </application>
        </manifest>
        EOF

        # Create minimal native activity
        cat > android-game/app/src/main/cpp/android_main.cpp << 'EOF'
        #include <android/native_activity.h>
        #include <android/log.h>

        void ANativeActivity_onCreate(ANativeActivity* activity, void* savedState, size_t savedStateSize) {
            LOGI("Prisma Game Native Activity Created");
            // TODO: Initialize game engine
        }
        EOF

    - name: Configure and Build
      run: |
        cd android-game
        cmake -B build \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ matrix.abi }} \
          -DANDROID_PLATFORM=24 \
          -DANDROID_STL=c++_shared \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -G Ninja

        cmake --build build --config ${{ matrix.build_type }} --parallel 2

    - name: Package APK
      if: github.event.inputs.upload_artifact == 'true' || github.event.inputs.upload_artifact == ''
      run: |
        cd android-game
        # Copy built library
        cp build/libgame.so app/src/main/jniLibs/${{ matrix.abi }}/

        # Create minimal gradle project structure
        mkdir -p app/src/main/res/{values,mipmap-hdpi,mipmap-mdpi,mipmap-xhdpi,mipmap-xxhdpi,mipmap-xxxhdpi}

        # Create strings.xml
        cat > app/src/main/res/values/strings.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <string name="app_name">Prisma Game</string>
        </resources>
        EOF

        # Create gradle files
        cat > app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
        }

        android {
            namespace 'com.prisma.game'
            compileSdk 34
            defaultConfig {
                applicationId "com.prisma.game"
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "1.0"
            }
            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
            }
            externalNativeBuild {
                cmake {
                    path 'CMakeLists.txt'
                }
            }
        }

        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
        }
        EOF

        cat > build.gradle << 'EOF'
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
        }

        plugins {
            id 'com.android.application' version '8.0.2' apply false
        }

        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }

        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

        # Create gradle.properties
        echo "android.useAndroidX=true" > gradle.properties
        echo "android.enableJetifier=true" >> gradle.properties

        # Create settings.gradle
        echo "include ':app'" > settings.gradle

        # Build APK (simplified, would need proper keystore for release)
        echo "Android project structure created. APK building requires proper keystore configuration."

    - name: Create Android Package
      if: github.event.inputs.upload_artifact == 'true' || github.event.inputs.upload_artifact == ''
      run: |
        mkdir -p PrismaGame-android-${{ matrix.abi }}
        cp -r android-game/* PrismaGame-android-${{ matrix.abi }}/
        tar czf PrismaGame-android-${{ matrix.abi }}-${{ matrix.build_type }}.tar.gz PrismaGame-android-${{ matrix.abi }}/

    - name: Upload artifacts
      if: github.event.inputs.upload_artifact == 'true' || github.event.inputs.upload_artifact == ''
      uses: actions/upload-artifact@v4
      with:
        name: PrismaGame-android-${{ matrix.abi }}-${{ matrix.build_type }}
        path: PrismaGame-android-${{ matrix.abi }}-${{ matrix.build_type }}.tar.gz
        retention-days: 30

  # Create release
  create-release:
    needs: [build-windows, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/**/*.zip
          artifacts/**/*.tar.gz
        draft: false
        prerelease: false
        generate_release_notes: true
        name: Prisma Game ${{ github.ref_name }}
        body: |
          ## Prisma Game ${{ github.ref_name }}

          ### Downloads
          - Windows x64: `PrismaGame-x64-Release.zip`
          - Android: `PrismaGame-android-*-Release.tar.gz`

          ### Installation

          #### Windows
          1. Download `PrismaGame-x64-Release.zip`
          2. Extract to a folder
          3. Run `RunGame.bat` or `Runtime.exe`

          #### Android
          1. Download the appropriate Android package
          2. Build APK using Android Studio (keystore required)
          3. Install APK on device

          ### Requirements
          - **Windows**: Windows 10, DirectX 12, 4GB RAM
          - **Android**: Android 7.0+, OpenGL ES 3.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}