# GitHub Actions 工作流：自动构建 Android 项目
# 支持 NDK 和 Gradle 缓存，加快构建速度

name: Android CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'projects/android/PrismaAndroid/**'
      - '.github/workflows/build-android.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'projects/android/PrismaAndroid/**'
      - '.github/workflows/build-android.yml'
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    name: 构建 Android 项目
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: projects/android/PrismaAndroid

    steps:
      # ============ 1. 检出代码 ============
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ============ 2. 设置 JDK ============
      - name: 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ============ 3. 缓存 Gradle 依赖 ============
      # 缓存 Gradle 依赖包，避免每次重新下载
      - name: 缓存 Gradle 依赖
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-android-${{ hashFiles('projects/android/PrismaAndroid/**/*.gradle*', 'projects/android/PrismaAndroid/**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-android-

      # ============ 4. 缓存 Android NDK ============
      # NDK 体积很大（约 1-2GB），缓存可以显著节省时间和带宽
      - name: 缓存 Android NDK
        uses: actions/cache@v4
        with:
          path: |
            ~/Android/Sdk/ndk
            ~/.android/build-cache
          key: ndk-${{ runner.os }}-${{ hashFiles('projects/android/PrismaAndroid/**/ndk_version.txt', 'projects/android/PrismaAndroid/**/build.gradle*', 'projects/android/PrismaAndroid/**/gradle.properties') }}
          restore-keys: |
            ndk-${{ runner.os }}-

      # ============ 5. 缓存 CMake 构建缓存 ============
      # 缓存 CMake 的构建中间文件
      - name: 缓存 CMake 构建缓存
        uses: actions/cache@v4
        with:
          path: |
            projects/android/PrismaAndroid/**/.cxx
            projects/android/PrismaAndroid/**/build/.cxx
          key: cmake-${{ runner.os }}-${{ hashFiles('projects/android/PrismaAndroid/**/CMakeLists.txt', 'projects/android/PrismaAndroid/**/build.gradle*') }}
          restore-keys: |
            cmake-${{ runner.os }}-

      # ============ 6. 授予执行权限 ============
      - name: 授予 Gradlew 执行权限
        run: chmod +x ./gradlew

      # ============ 7. 构建项目 ============
      # 使用 --build-cache 启用 Gradle 构建缓存
      # 使用 --parallel 并行构建模块
      - name: 构建 Debug APK
        run: ./gradlew assembleDebug --build-cache --parallel --stacktrace || ./gradlew assembleDebug --stacktrace

      # ============ 8. 构建 Release APK（可选）============
      # 如果需要签名 Release 版本，需要配置签名密钥
      - name: 构建 Release APK
        run: ./gradlew assembleRelease --build-cache --parallel --stacktrace || echo "Release build skipped"

      # ============ 9. 上传构建产物 ============
      - name: 上传 Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: projects/android/PrismaAndroid/app/build/outputs/apk/debug/*.apk
          retention-days: 30  # 保留 30 天

      - name: 上传 Release APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: projects/android/PrismaAndroid/app/build/outputs/apk/release/*.apk
          retention-days: 30
          if-no-files-found: ignore  # 如果没有 Release APK 也不报错

      # ============ 10. 更新 latest Release（固定直链）============
      - name: 准备 APK 文件
        if: github.ref == 'refs/heads/main' && success()
        run: |
          mkdir -p latest-release
          find app/build/outputs/apk/release -name "*.apk" -exec cp {} latest-release/PrismaAndroid.apk \;

      - name: 更新 latest tag
        if: github.ref == 'refs/heads/main' && success()
        run: |
          git tag -f latest
          git push -f origin latest

      - name: 更新 latest Release
        if: github.ref == 'refs/heads/main' && success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          body: |
            ## 最新构建版本

            构建时间: ${{ github.event.head_commit.timestamp }}
            Commit: ${{ github.event.head_commit.message }}

            ### 下载
            - **APK 直链**: [PrismaAndroid.apk](https://github.com/${{ github.repository }}/releases/download/latest/PrismaAndroid.apk)
          files: projects/android/PrismaAndroid/latest-release/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============ 11. 上传构建报告 ============
      - name: 上传构建日志
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            projects/android/PrismaAndroid/**/build/reports/
            projects/android/PrismaAndroid/app/build/outputs/logs/
          retention-days: 7
