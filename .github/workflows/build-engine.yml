name: Build Engine SDK

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/engine/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - 'cmake/**'
      - '.github/workflows/build-engine.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/engine/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - 'cmake/**'
      - '.github/workflows/build-engine.yml'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Debug'
        type: choice
        options:
        - Debug
        - Release
        - Both
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - windows
        - android

env:
  CMAKE_VERSION: '3.31.0'
  ANDROID_NDK_VERSION: 27.0.12077973

jobs:
  build-engine:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            build_type: Debug
            arch: x64
            artifact_suffix: win64-debug
            preset: windows-x64-debug
          - os: ubuntu-latest
            platform: android
            build_type: Debug
            abi: arm64-v8a
            artifact_suffix: android-arm64-debug
          - os: ubuntu-latest
            platform: android
            build_type: Debug
            abi: armeabi-v7a
            artifact_suffix: android-arm32-debug

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}

    # Windows build
    - name: Cache CMake build (Windows)
      if: matrix.platform == 'windows'
      uses: actions/cache@v4
      with:
        path: |
          ./build/${{ matrix.preset }}
        key: ${{ runner.os }}-engine-${{ matrix.preset }}-${{ hashFiles('src/engine/**', 'CMakeLists.txt', 'CMakePresets.json') }}
        restore-keys: |
          ${{ runner.os }}-engine-${{ matrix.preset }}-
          ${{ runner.os }}-engine-

    - name: Configure CMake (Windows)
      if: matrix.platform == 'windows'
      run: cmake --preset ${{ matrix.preset }}

    - name: Build Engine (Windows)
      if: matrix.platform == 'windows'
      run: |
        cmake --build build/${{ matrix.preset }} --config ${{ matrix.build_type }} --parallel

    # Android build
    - name: Setup Android NDK
      if: matrix.platform == 'android'
      uses: android-actions/setup-android@v3

    - name: Setup NDK
      if: matrix.platform == 'android'
      run: |
        yes | $ANDROID_HOME/tools/bin/sdkmanager --install "ndk;${{ env.ANDROID_NDK_VERSION }}"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV

    - name: Setup Ninja (Android)
      if: matrix.platform == 'android'
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build

    - name: Cache CMake build (Android)
      if: matrix.platform == 'android'
      uses: actions/cache@v4
      with:
        path: |
          ./build-android-${{ matrix.abi }}-debug
        key: ${{ runner.os }}-engine-android-${{ matrix.abi }}-${{ hashFiles('src/engine/**', 'CMakeLists.txt', 'android/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-engine-android-${{ matrix.abi }}-
          ${{ runner.os }}-engine-android-

    - name: Configure CMake (Android)
      if: matrix.platform == 'android'
      run: |
        cmake -S android -B build-${{ matrix.artifact_suffix }} \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ matrix.abi }} \
          -DANDROID_PLATFORM=24 \
          -DANDROID_STL=c++_shared \
          -DCMAKE_BUILD_TYPE=Debug \
          -G Ninja

    - name: Build Engine (Android)
      if: matrix.platform == 'android'
      run: |
        cmake --build build-${{ matrix.artifact_suffix }} --parallel 2

    - name: Package (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir -p package-${{ matrix.artifact_suffix }}/lib/Debug
        mkdir -p package-${{ matrix.artifact_suffix }}/include

        # Copy library files
        copy build/${{ matrix.preset }}/lib/Debug/PrismaEngine.lib package-${{ matrix.artifact_suffix }}/lib/Debug/

        # Copy headers
        xcopy src/engine\*.h package-${{ matrix.artifact_suffix }}/include /E /I /Y 2>nul || echo "No headers to copy"

        # Create archive
        cd package-${{ matrix.artifact_suffix }}
        7z a ../PrismaEngine-${{ matrix.artifact_suffix }}.zip *

    - name: Package (Android)
      if: matrix.platform == 'android'
      run: |
        mkdir -p artifacts/${{ matrix.abi }}
        cmake --install build-${{ matrix.artifact_suffix }} \
          --config Debug \
          --prefix artifacts/${{ matrix.abi }}
        tar czf PrismaEngine-${{ matrix.artifact_suffix }}.tar.gz -C artifacts .

    - name: Upload artifacts (Windows)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: PrismaEngine-${{ matrix.artifact_suffix }}
        path: PrismaEngine-${{ matrix.artifact_suffix }}.zip
        retention-days: 30

    - name: Upload artifacts (Android)
      if: matrix.platform == 'android'
      uses: actions/upload-artifact@v4
      with:
        name: PrismaEngine-${{ matrix.artifact_suffix }}
        path: PrismaEngine-${{ matrix.artifact_suffix }}.tar.gz
        retention-days: 30

  # Release build (manual only)
  build-engine-release:
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.build_type == 'Release' || github.event.inputs.build_type == 'Both')
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            build_type: Release
            arch: x64
            artifact_suffix: win64-release
            preset: windows-x64-release
          - os: ubuntu-latest
            platform: android
            build_type: Release
            abi: arm64-v8a
            artifact_suffix: android-arm64-release
          - os: ubuntu-latest
            platform: android
            build_type: Release
            abi: armeabi-v7a
            artifact_suffix: android-arm32-release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}

    # Windows build
    - name: Cache CMake build (Windows)
      if: matrix.platform == 'windows'
      uses: actions/cache@v4
      with:
        path: |
          ./build/${{ matrix.preset }}
        key: ${{ runner.os }}-engine-rel-${{ matrix.preset }}-${{ hashFiles('src/engine/**', 'CMakeLists.txt', 'CMakePresets.json') }}
        restore-keys: |
          ${{ runner.os }}-engine-rel-${{ matrix.preset }}-
          ${{ runner.os }}-engine-rel-

    - name: Configure CMake (Windows)
      if: matrix.platform == 'windows'
      run: cmake --preset ${{ matrix.preset }}

    - name: Build Engine (Windows)
      if: matrix.platform == 'windows'
      run: |
        cmake --build build/${{ matrix.preset }} --config ${{ matrix.build_type }} --parallel

    # Android build
    - name: Setup Android NDK
      if: matrix.platform == 'android'
      uses: android-actions/setup-android@v3

    - name: Setup NDK
      if: matrix.platform == 'android'
      run: |
        yes | $ANDROID_HOME/tools/bin/sdkmanager --install "ndk;${{ env.ANDROID_NDK_VERSION }}"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV

    - name: Setup Ninja (Android)
      if: matrix.platform == 'android'
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build

    - name: Cache CMake build (Android)
      if: matrix.platform == 'android'
      uses: actions/cache@v4
      with:
        path: |
          ./build-android-${{ matrix.abi }}-release
        key: ${{ runner.os }}-engine-rel-android-${{ matrix.abi }}-${{ hashFiles('src/engine/**', 'CMakeLists.txt', 'android/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-engine-rel-android-${{ matrix.abi }}-
          ${{ runner.os }}-engine-rel-android-

    - name: Configure CMake (Android)
      if: matrix.platform == 'android'
      run: |
        cmake -S android -B build-${{ matrix.artifact_suffix }} \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ matrix.abi }} \
          -DANDROID_PLATFORM=24 \
          -DANDROID_STL=c++_shared \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -G Ninja

    - name: Build Engine (Android)
      if: matrix.platform == 'android'
      run: |
        cmake --build build-${{ matrix.artifact_suffix }} --parallel 2

    - name: Package (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir -p package-${{ matrix.artifact_suffix }}/lib/Release
        mkdir -p package-${{ matrix.artifact_suffix }}/include

        # Copy library files
        copy build/${{ matrix.preset }}/lib/Release/PrismaEngine.lib package-${{ matrix.artifact_suffix }}/lib/Release/

        # Copy headers
        xcopy src/engine\*.h package-${{ matrix.artifact_suffix }}/include /E /I /Y 2>nul || echo "No headers to copy"

        # Create archive
        cd package-${{ matrix.artifact_suffix }}
        7z a ../PrismaEngine-${{ matrix.artifact_suffix }}.zip *

    - name: Package (Android)
      if: matrix.platform == 'android'
      run: |
        mkdir -p artifacts/${{ matrix.abi }}
        cmake --install build-${{ matrix.artifact_suffix }} \
          --config ${{ matrix.build_type }} \
          --prefix artifacts/${{ matrix.abi }}
        tar czf PrismaEngine-${{ matrix.artifact_suffix }}.tar.gz -C artifacts .

    - name: Upload artifacts (Windows)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: PrismaEngine-${{ matrix.artifact_suffix }}
        path: PrismaEngine-${{ matrix.artifact_suffix }}.zip
        retention-days: 30

    - name: Upload artifacts (Android)
      if: matrix.platform == 'android'
      uses: actions/upload-artifact@v4
      with:
        name: PrismaEngine-${{ matrix.artifact_suffix }}
        path: PrismaEngine-${{ matrix.artifact_suffix }}.tar.gz
        retention-days: 30
