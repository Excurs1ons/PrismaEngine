name: Build All (Release)

on:
  workflow_dispatch:

env:
  CMAKE_VERSION: '3.31.0'
  ANDROID_NDK_VERSION: 27.0.12077973

jobs:
  build-engine:
    name: Build Engine SDK
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            build_type: Release
            artifact_suffix: win64-release
            preset: windows-x64-release
          - os: ubuntu-latest
            platform: android
            build_type: Release
            abi: arm64-v8a
            artifact_suffix: android-arm64-release
          - os: ubuntu-latest
            platform: android
            build_type: Release
            abi: armeabi-v7a
            artifact_suffix: android-arm32-release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}

    # Windows
    - name: Cache CMake build (Windows)
      if: matrix.platform == 'windows'
      uses: actions/cache@v4
      with:
        path: ./build/${{ matrix.preset }}
        key: ${{ runner.os }}-all-${{ matrix.preset }}-${{ hashFiles('src/engine/**', 'CMakeLists.txt', 'CMakePresets.json') }}

    - name: Configure CMake (Windows)
      if: matrix.platform == 'windows'
      run: cmake --preset ${{ matrix.preset }}

    - name: Build Engine (Windows)
      if: matrix.platform == 'windows'
      run: cmake --build build/${{ matrix.preset }} --config ${{ matrix.build_type }} --parallel

    # Android
    - name: Setup Android NDK
      if: matrix.platform == 'android'
      uses: android-actions/setup-android@v3

    - name: Setup NDK
      if: matrix.platform == 'android'
      run: |
        yes | $ANDROID_HOME/tools/bin/sdkmanager --install "ndk;${{ env.ANDROID_NDK_VERSION }}"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV

    - name: Setup Ninja
      if: matrix.platform == 'android'
      run: sudo apt-get install -y ninja-build

    - name: Cache CMake build (Android)
      if: matrix.platform == 'android'
      uses: actions/cache@v4
      with:
        path: ./build-android-${{ matrix.abi }}-release
        key: ${{ runner.os }}-all-android-${{ matrix.abi }}-${{ hashFiles('src/engine/**', 'CMakeLists.txt', 'android/CMakeLists.txt') }}

    - name: Configure CMake (Android)
      if: matrix.platform == 'android'
      run: |
        cmake -S android -B build-${{ matrix.artifact_suffix }} \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ matrix.abi }} \
          -DANDROID_PLATFORM=24 \
          -DANDROID_STL=c++_shared \
          -DCMAKE_BUILD_TYPE=Release \
          -G Ninja

    - name: Build Engine (Android)
      if: matrix.platform == 'android'
      run: cmake --build build-${{ matrix.artifact_suffix }} --parallel 2

    - name: Package (Windows)
      if: matrix.platform == 'windows'
      run: |
        mkdir -p package-${{ matrix.artifact_suffix }}/lib/Release
        mkdir -p package-${{ matrix.artifact_suffix }}/include
        copy build/${{ matrix.preset }}/lib/Release/PrismaEngine.lib package-${{ matrix.artifact_suffix }}/lib/Release/
        xcopy src/engine\*.h package-${{ matrix.artifact_suffix }}/include /E /I /Y 2>nul || echo "No headers"
        cd package-${{ matrix.artifact_suffix }}
        7z a ../PrismaEngine-${{ matrix.artifact_suffix }}.zip *

    - name: Package (Android)
      if: matrix.platform == 'android'
      run: |
        mkdir -p artifacts/${{ matrix.abi }}
        cmake --install build-${{ matrix.artifact_suffix }} --config Release --prefix artifacts/${{ matrix.abi }}
        tar czf PrismaEngine-${{ matrix.artifact_suffix }}.tar.gz -C artifacts .

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PrismaEngine-${{ matrix.artifact_suffix }}
        path: |
          PrismaEngine-${{ matrix.artifact_suffix }}.zip
          PrismaEngine-${{ matrix.artifact_suffix }}.tar.gz
        retention-days: 30
        if-no-files-found: ignore

  build-editor:
    name: Build Editor
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: ./build/windows-x64-release
        key: ${{ runner.os }}-all-editor-${{ hashFiles('src/**', 'CMakeLists.txt', 'CMakePresets.json') }}

    - name: Configure CMake
      run: cmake --preset windows-x64-release

    - name: Build Editor
      run: cmake --build build/windows-x64-release --config Release --target Editor --parallel

    - name: Package
      run: |
        mkdir -p package-x64-release
        copy build/windows-x64-release/bin/Release/Editor.exe package-x64-release/
        copy build/windows-x64-release/bin/Release/*.dll package-x64-release/ 2>nul || echo "No DLLs"
        xcopy assets package-x64-release/assets /E /I /Y 2>nul || echo "No assets"
        cd package-x64-release
        7z a ../PrismaEditor-x64-release.zip *

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PrismaEditor-x64-release
        path: PrismaEditor-x64-release.zip
        retention-days: 30

  build-windows-runtime:
    name: Build Windows Runtime
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: ./build/windows-x64-release
        key: ${{ runner.os }}-all-runtime-${{ hashFiles('src/**', 'CMakeLists.txt', 'CMakePresets.json') }}

    - name: Configure CMake
      run: cmake --preset windows-x64-release

    - name: Build Runtime
      run: cmake --build build/windows-x64-release --config Release --target Runtime --parallel

    - name: Build Game
      run: cmake --build build/windows-x64-release --config Release --target Game --parallel

    - name: Package
      run: |
        mkdir -p package-x64-release
        copy build/windows-x64-release/bin/Release/Runtime.exe package-x64-release/
        copy build/windows-x64-release/bin/Release/*.dll package-x64-release/ 2>nul || echo "No DLLs"
        xcopy assets package-x64-release/assets /E /I /Y 2>nul || echo "No assets"
        xcopy projects package-x64-release/projects /E /I /Y 2>nul || echo "No projects"
        cd package-x64-release
        7z a ../PrismaGame-x64-release.zip *

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PrismaGame-x64-release
        path: PrismaGame-x64-release.zip
        retention-days: 30

  build-android-runtime:
    name: Build Android Runtime
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: projects/android/PrismaAndroid

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup Android NDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-android-all-${{ hashFiles('projects/android/PrismaAndroid/**/*.gradle*') }}

    - name: Grant execute permission
      run: chmod +x ./gradlew

    - name: Build Release APK
      run: ./gradlew assembleRelease --build-cache --parallel

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-runtime-release
        path: projects/android/PrismaAndroid/app/build/outputs/apk/release/*.apk
        retention-days: 30
        if-no-files-found: ignore
