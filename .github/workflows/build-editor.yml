name: Build Editor

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/editor/**'
      - 'src/engine/**'
      - '.github/workflows/build-editor.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/editor/**'
      - 'src/engine/**'
      - '.github/workflows/build-editor.yml'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Debug'
        type: choice
        options:
        - Debug
        - Release

env:
  CMAKE_VERSION: '3.31.0'

jobs:
  # Debug build (auto on push)
  build-editor-debug:
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.build_type == 'Debug'
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          ./build/windows-x64-debug
        key: ${{ runner.os }}-editor-debug-${{ hashFiles('src/**', 'CMakeLists.txt', 'CMakePresets.json') }}
        restore-keys: |
          ${{ runner.os }}-editor-debug-
          ${{ runner.os }}-editor-

    - name: Configure CMake
      run: cmake --preset windows-x64-debug

    - name: Build Editor
      run: |
        cmake --build build/windows-x64-debug --config Debug --target Editor --parallel

    - name: Package
      run: |
        mkdir -p package-x64-debug
        # Copy executable
        copy build/windows-x64-debug/bin/Debug/Editor.exe package-x64-debug/
        # Copy required DLLs
        copy build/windows-x64-debug/bin/Debug/*.dll package-x64-debug/ 2>nul || echo "No DLLs to copy"
        # Copy assets
        xcopy assets package-x64-debug/assets /E /I /Y 2>nul || echo "No assets to copy"
        # Create archive
        cd package-x64-debug
        7z a ../PrismaEditor-x64-debug.zip *

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PrismaEditor-x64-debug
        path: PrismaEditor-x64-debug.zip
        retention-days: 30

  # Release build (manual only)
  build-editor-release:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'Release'
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2.0
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          ./build/windows-x64-release
        key: ${{ runner.os }}-editor-release-${{ hashFiles('src/**', 'CMakeLists.txt', 'CMakePresets.json') }}
        restore-keys: |
          ${{ runner.os }}-editor-release-
          ${{ runner.os }}-editor-

    - name: Configure CMake
      run: cmake --preset windows-x64-release

    - name: Build Editor
      run: |
        cmake --build build/windows-x64-release --config Release --target Editor --parallel

    - name: Package
      run: |
        mkdir -p package-x64-release
        # Copy executable
        copy build/windows-x64-release/bin/Release/Editor.exe package-x64-release/
        # Copy required DLLs
        copy build/windows-x64-release/bin/Release/*.dll package-x64-release/ 2>nul || echo "No DLLs to copy"
        # Copy assets
        xcopy assets package-x64-release/assets /E /I /Y 2>nul || echo "No assets to copy"
        # Create archive
        cd package-x64-release
        7z a ../PrismaEditor-x64-release.zip *

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PrismaEditor-x64-release
        path: PrismaEditor-x64-release.zip
        retention-days: 30
